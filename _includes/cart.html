<!-- Cart Drawer -->
<div id="cartDrawer" class="fixed right-0 top-0 max-h-screen bg-card shadow-lg p-6 hidden z-50 overflow-y-auto pt-16 inline-block" style="width:auto">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-white">Your Cart</h2>
    <button onclick="closeCart()" class="text-white">‚úï</button>
  </div>
  <div id="cartRows" class="flex flex-col w-max"></div>
  <div id="cartNote"></div>
  <div class="mt-6 text-center">
    <button onclick="goToCheckoutFromCart()" class="bg-blue-500 w-full py-2 rounded text-white">Checkout</button>
  </div>
</div>

<!-- Cart Logic -->
<script>
  const BASEURL = "{{ site.baseurl }}";
  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  function getCurrencyCode(locale) {
    const country = locale.split("-")[1] || "US";
    const currencyMap = {
      MY: "MYR", US: "USD", SG: "SGD", JP: "JPY", GB: "GBP"
    };
    return currencyMap[country] || "USD";
  }

  function getFormatter(locale) {
    const currency = getCurrencyCode(locale);
    return new Intl.NumberFormat(locale, {
      style: "currency",
      currency,
      minimumFractionDigits: 2
    });
  }

  function formatPrice(prices) {
    const locale = localStorage.getItem("preferredLocale") || navigator.language || "en-US";
    const currency = getCurrencyCode(locale);
    const formatter = getFormatter(locale);
    const price = prices[currency] || prices["USD"] || 0;
    return formatter.format(price);
  }

  function addToCart(product) {
    const existingIndex = cart.findIndex(i => i.name === product.name);
    if (existingIndex !== -1) {
      cart[existingIndex].quantity = (cart[existingIndex].quantity || 1) + 1;
    } else {
      product.quantity = 1;
      cart.push(product);
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
    updateCartCount();
    document.getElementById('cartDrawer').classList.remove('hidden');
  }

  function removeFromCart(index) {
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
    updateCartCount();
  }

  function updateQuantity(index, change) {
    if (!cart[index].quantity) cart[index].quantity = 1;
    const newQty = cart[index].quantity + change;
    if (newQty >= 1) {
      cart[index].quantity = newQty;
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
      updateCartCount();
    }
  }

  function renderCart() {
    const rows = document.getElementById('cartRows');
    const noteContainer = document.getElementById('cartNote');
    if (!rows || !noteContainer) return;
    rows.innerHTML = '';
    noteContainer.innerHTML = '';

    const locale = localStorage.getItem("preferredLocale") || navigator.language || "en-US";
    const currency = getCurrencyCode(locale);
    const formatter = getFormatter(locale);

    let total = 0;
    cart.forEach((item, index) => {
      if (!item.quantity) item.quantity = 1;
      const priceValue = item.prices?.[currency] || item.prices?.USD || 0;
      total += priceValue * item.quantity;

      const div = document.createElement('div');
      div.className = 'flex items-center gap-4 text-white py-2 border-b border-gray-700 w-max';
      const minusBtn = item.quantity === 1
        ? '<button disabled class="px-2 text-white opacity-30 cursor-not-allowed">‚àí</button>'
        : `<button onclick="updateQuantity(${index}, -1)" class="px-2 text-white">‚àí</button>`;
      div.innerHTML = `
        <img src="${BASEURL}${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded">
        <div class="w-max">
          <div class="text-white whitespace-nowrap">${item.name}</div>
          ${item.selection ? `<div class="text-xs text-gray-400 whitespace-nowrap">${item.selection}</div>` : ''}
          <div class="text-sm text-gray-400 whitespace-nowrap">${formatter.format(priceValue)}</div>
        </div>
        <div class="flex items-center gap-2">
          ${minusBtn}
          <span class="text-sm text-white">${item.quantity}</span>
          <button onclick="updateQuantity(${index}, 1)" class="px-2 text-white">+</button>
          <button onclick="removeFromCart(${index})" class="text-gray-400 hover:text-red-500">üóëÔ∏è</button>
        </div>
      `;
      rows.appendChild(div);
    });

    const summary = document.createElement('div');
    summary.className = 'text-white text-right mt-4';
    summary.innerHTML = `<strong>Subtotal:</strong> ${formatter.format(total)}`;
    rows.appendChild(summary);

    const note = document.createElement('div');
    note.className = 'text-xs text-gray-400 mt-2 break-words whitespace-normal max-w-full';
    note.textContent = 'Customs duties and import taxes for international orders are not included and may be charged separately by your local authorities.';
    note.style.wordBreak = 'break-word';
    noteContainer.appendChild(note);

    adjustCartWidth();
  }

  function closeCart() {
    document.getElementById('cartDrawer').classList.add('hidden');
  }

  function toggleCart() {
    const drawer = document.getElementById('cartDrawer');
    drawer.classList.toggle('hidden');
    updateCartCount();
    if (!drawer.classList.contains('hidden')) adjustCartWidth();
  }

  function updateCartCount() {
    const count = (cart || []).reduce((sum, item) => sum + (item.quantity || 1), 0);
    const badge = document.getElementById('cartCount');
    if (badge) badge.textContent = count;
  }

  document.addEventListener('DOMContentLoaded', () => {
    renderCart();
    updateCartCount();
    adjustCartWidth();
  });

  window.addEventListener('resize', adjustCartWidth);

  function goToCheckoutFromCart() {
    // Mark navigation as coming from Cart (not Product)
    sessionStorage.setItem('fromProductPage', 'false');
    // Also force the cart mode via URL so checkout overrides any stale state
    window.location.href = "{{ '/checkout' | relative_url }}?mode=cart";
  }

  function adjustCartWidth() {
    const drawer = document.getElementById('cartDrawer');
    const rows = document.getElementById('cartRows');
    if (!drawer || !rows) return;
    requestAnimationFrame(() => {
      const styles = getComputedStyle(drawer);
      const padL = parseFloat(styles.paddingLeft) || 0;
      const padR = parseFloat(styles.paddingRight) || 0;
      const target = rows.offsetWidth + padL + padR;
      drawer.style.width = `${Math.max(260, Math.ceil(target))}px`;
    });
  }
</script>
