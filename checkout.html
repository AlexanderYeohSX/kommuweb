---
layout: default
title: Checkout
---

{% include pricing_helpers.html %}

<!-- Checkout Page Layout -->
<div class="max-w-6xl mx-auto px-4 py-12">
  <!-- Checkout Title -->
  <div class="text-left mb-10">
    <h1 class="text-4xl font-bold mb-2 text-white">Checkout</h1>
  </div>

  <!-- Form and Cart Summary Layout -->
  <div id="checkoutGrid" class="grid md:grid-cols-2 gap-8">
    <!-- Left Form Fields -->
    <div class="text-white space-y-6">
      <div>
        <label for="checkoutName" class="block text-sm font-semibold mb-1">First Name</label>
        <input id="checkoutName" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div id="checkoutICGroup" class="hidden">
        <label for="checkoutIC" class="block text-sm font-semibold mb-1">
          Malaysian IC No. (without –)
        </label>
        <input id="checkoutIC" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" pattern="\d{12}" required
        >
      </div>
      <div>
        <label for="checkoutEmail" class="block text-sm font-semibold mb-1">Email</label>
        <input id="checkoutEmail" type="email" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div>
        <label for="checkoutMobile" class="block text-sm font-semibold mb-1">Contact number</label>
        <input id="checkoutMobile" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div>
        <label for="checkoutAddress" class="block text-sm font-semibold mb-1">Street Address</label>
        <input id="checkoutAddress" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div>
        <label for="checkoutPostcode" class="block text-sm font-semibold mb-1">Postcode</label>
        <input id="checkoutPostcode" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div>
        <label for="checkoutCountry" class="block text-sm font-semibold mb-1">Country</label>
        <select id="checkoutCountry" class="w-full bg-black border border-gray-700 px-4 py-3 rounded text-white" required>
          {% for entry in site.data.shipping %}
            <option value="{{ entry.code }}">{{ entry.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="checkoutPromoGroup" class="mt-4">
        <label for="checkoutPromoInput" class="block text-sm font-semibold mb-1">Promo code</label>
        <input id="checkoutPromoInput" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded">
        <p id="checkoutPromoValidity" class="text-yellow-400 mt-1" hidden></p>
      </div>
    </div>

    <!-- Right Cart Summary -->
    <div id="checkoutCartSection" class="text-white">
      <h2 class="text-lg font-semibold mb-4 text-white">Your Cart</h2>
      <div id="checkoutCartItems" class="space-y-4 mb-6"></div>
      <div class="text-sm text-right">
        <p class="mb-1">Subtotal <span id="checkoutCartSubtotal" class="font-semibold ml-2">RM0</span></p>
        <p class="text-xs text-gray-400">Customs duties and import taxes for international orders are not included and may be charged separately by your local authorities.</p>
      </div>
    </div>
  </div>
</div>
<section class="w-full bg-card py-6">
  <div class="max-w-6xl mx-auto px-6 text-white grid md:grid-cols-3 gap-6">
    <!-- Col 1: image & headline -->
    <div>
      <h2 id="summaryHeading" class="text-2xl font-bold mb-2 text-white">Welcome to Kommunity</h2>
      <p class="font-medium mb-6">Cruise with intelligence.</p>
      <img
        src="{{ '/img/products/device/1.png' | relative_url }}"
        alt="Summary image"
        class="w-full rounded"
      >
    </div>

    <!-- Col 2: placeholder for either product summary or shipping -->
    <div id="summaryCol2" class="space-y-6">
    </div>

    <!-- Col 3: placeholder for either payment summary+CTA or total due-->
    <div id="summaryCol3">
    </div>
  </div>
</section>
<script>
  const shippingConfig = {{ site.data.shipping | jsonify }};
  const locale    = KommuPricing.getPreferredLocale();
  const currency  = KommuPricing.getCurrencyCode(locale);
  const formatter = KommuPricing.getFormatter(locale);

  // Global helpers so both DOM init and checkoutSubmit can use them
  function getDevicePriceByCurrency(curr) {
    try {
      const dev = (products || []).find(p => (p.name||"").toLowerCase() === "kommuassist2");
      if (!dev) return 0;
      const prices = dev.prices || {};
      // Accept curr in any case, fallback to USD
      const ccy = (curr || '').toUpperCase();
      const val = prices[ccy] ?? prices.USD ?? 0;
      return parseFloat(val) || 0;
    } catch (e) { return 0; }
  }

  function computePlan() {
    const ccy = (currency || '').toUpperCase();
    const nonMYR = ccy !== 'MYR';
    const isFromProduct = sessionStorage.getItem('fromProductPage') === 'true';
    const selectionsRaw = sessionStorage.getItem('checkoutSelections');
    const selections = (isFromProduct && selectionsRaw) ? JSON.parse(selectionsRaw) : {};
    const plan = { provider: '', locks: {}, mode: isFromProduct ? 'product' : 'cart' };

    if (isFromProduct) {
      const wantsRTO = (selections.payment||'').toLowerCase().includes('rent-to-own');
      if (!nonMYR && !wantsRTO) {
        // 1) product • MYR • one-off • device
        plan.provider = 'curlec-otp';
        plan.locks = { country: 'MY', icRequired: false };
      } else if (!nonMYR && wantsRTO) {
        // 2) product • MYR • RTO • device
        plan.provider = 'curlec-sub';
        plan.locks = { country: 'MY', icRequired: true, forceNoSim: true, forceNoTradeIn: true };
      } else {
        // 3) product • non-MYR • any • device
        plan.provider = 'stripe';
        plan.locks = { icRequired: false, forceOneOff: true, forceNoSim: true, forceNoTradeIn: true, forceSelfInstall: true };
      }
    } else {
      // CART FLOWS (accessories-only here)
      if (ccy === 'MYR') {
        // 4) cart • MYR • accessories-only
        plan.provider = 'curlec-otp';
        plan.locks = { hidePromo: true, country: 'MY' };
      } else {
        // 5) cart • non-MYR • accessories-only
        plan.provider = 'stripe';
        plan.locks = { hidePromo: true };
      }
    }
    return plan;
  }

  function computePricingForSelections(selections){
    {
        const ctx = {
          source: (sessionStorage.getItem('fromProductPage')==='true') ? 'product' : 'cart',
          currency,
          payment: /rent-to-own/i.test(selections.payment||'') ? 'Rent-to-own' : 'One-off Purchase',
          dropdowns: selections
        };
        const thenBlock   = KommuPricing.matchRule(ctx) || {};
        const promoLabels = (thenBlock.auto_apply?.promotion?.label) ? [thenBlock.auto_apply.promotion.label] : [];

        // Device pricing (promo-aware)
        const deviceOneOff  = KommuPricing.getDevicePriceByCurrency(currency,  promoLabels);
        const deviceMonthly = KommuPricing.getDeviceMonthlyByCurrency(currency, promoLabels);

        // Bundled add-ons from selections (promo/rule-aware)
        const bundled = KommuPricing.getAddonSurchargeFromSelections(selections, currency, thenBlock);

        // Subscription meta (prefer promo override if present)
        let months = 36;
        let subscriptionId = '';
        try {
          const dev = (window.products||[]).find(p => (p.name||'').toLowerCase()==='kommuassist2');
          if (dev?.subscription) {
            months = parseInt(dev.subscription.month || 36, 10) || 36;
            subscriptionId = dev.subscription.id || '';
          }
        } catch(_) {}
        if (thenBlock.auto_apply?.promotion) {
          const pr = thenBlock.auto_apply.promotion;
          if (pr.subscriptionId) subscriptionId = pr.subscriptionId;
          if (pr.months) months = parseInt(pr.months, 10) || months;
        }

        return { thenBlock, promoLabels, deviceOneOff, deviceMonthly, bundled, months, subscriptionId };
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const cartItems      = JSON.parse(localStorage.getItem("cart")) || [];
    const selectionsRaw  = sessionStorage.getItem("checkoutSelections");
    let isFromProduct  = sessionStorage.getItem("fromProductPage") === "true";

    // Resolve source of checkout view

    function applyLocks(plan) {
      const ctry = document.getElementById('checkoutCountry');
      if (plan.locks.country) { ctry.value = plan.locks.country; ctry.disabled = true; } else { ctry.disabled = false; }
      if (plan.locks.icRequired) { icGroup.classList.remove('hidden'); icInput.required = true; } else { icGroup.classList.add('hidden'); icInput.required = false; }
      if (plan.locks.hidePromo) { promoGroup.classList.add('hidden'); } else { promoGroup.classList.remove('hidden'); }

      // Force selection strings for product flow
      if (isFromProduct) {
        if (plan.locks.forceOneOff) { selections.payment = 'One-off purchase'; }
        if (plan.locks.forceNoSim) { selections.sim = 'with SIM Card'; }
        if (plan.locks.forceNoTradeIn) { selections.tradeIn = 'No Trade-in'; }
        if (plan.locks.forceSelfInstall) { selections.install = 'Self-installation'; }
        sessionStorage.setItem('checkoutSelections', JSON.stringify(selections));
      }
    }
    const urlParams = new URLSearchParams(location.search);
    const modeParam = urlParams.get('mode') || urlParams.get('src'); // allow ?mode=cart or ?src=cart
    if (modeParam === 'cart') {
      isFromProduct = false;
      sessionStorage.setItem('fromProductPage', 'false');
    } else if (modeParam === 'product') {
      isFromProduct = true;
      sessionStorage.setItem('fromProductPage', 'true');
    } else {
      // Heuristic: if both product-selection persisted and cart has items, prefer cart flow
      if (isFromProduct && cartItems && cartItems.length > 0) {
        isFromProduct = false;
      }
    }

    const cartSection     = document.getElementById("checkoutCartSection");
    const formGrid        = document.getElementById("checkoutGrid");
    const cartContainer   = document.getElementById("checkoutCartItems");
    const subtotalDisplay = document.getElementById("checkoutCartSubtotal");
    const col2            = document.getElementById("summaryCol2");
    const col3            = document.getElementById("summaryCol3");
    const heading         = document.getElementById("summaryHeading");

    const icGroup    = document.getElementById("checkoutICGroup");
    const icInput    = document.getElementById("checkoutIC");
    const promoGroup = document.getElementById("checkoutPromoGroup");

    let subtotal = 0;
    let selections = {};
    if (isFromProduct && selectionsRaw) {
      selections = JSON.parse(selectionsRaw);
    }
    

    // Compute plan and apply locks
    const isNonMYRCurrency = (currency || '').toUpperCase() !== 'MYR';
    const plan = computePlan();
    applyLocks(plan);


    // only show IC when user is RTO
    if (
      isFromProduct &&
      selections.payment &&
      selections.payment.toLowerCase().includes("rent-to-own")
    ) {
      icGroup.classList.remove("hidden");
      icInput.required = true;
    } else {
      icGroup.classList.add("hidden");
      icInput.required = false;
    }

    if (isFromProduct) {
      promoGroup.classList.remove("hidden");
    } else {
      promoGroup.classList.add("hidden");
    }
    
    // set default country based on user locale
    const countryInput = document.getElementById("checkoutCountry");
    const defaultCode = locale.split('-')[1]?.toUpperCase() || 'MY';
    countryInput.value = defaultCode;
    // Enforce plan country lock immediately
    if (plan.locks.country) { countryInput.value = plan.locks.country; countryInput.disabled = true; }
    countryInput.addEventListener("change", updateTotalDue);

    // compute shipping cost for default country (product page summary)
    const defaultCountryCode = countryInput.value.trim().toUpperCase();
    const productShipEntry = shippingConfig.find(e => e.code === defaultCountryCode) || {};
    const productShipCost  = parseFloat(productShipEntry.rates?.[currency] || 0);

    if (isFromProduct && Object.keys(selections).length) {

      const payLower = (selections.payment || "").toLowerCase();
      const instLower = (selections.install || "").toLowerCase();
      const allowCountry = payLower.includes("one-off") && instLower.includes("self-installation");

      if (allowCountry) {
        countryInput.disabled = false;
      } else {
        countryInput.value = 'MY';
        countryInput.value = defaultCode;
        countryInput.disabled = true;
      }
      heading.innerText    = "Your new KommuAssist";
      document.getElementById("checkoutCartSection").style.display = "none";
      document.getElementById("checkoutGrid").classList.remove("md:grid-cols-2");

      col2.innerHTML = `
        <div>
          <h3 class="text-xl font-bold mb-2 text-white">KommuAssist 2</h3>
          <p class="text-sm text-gray-300 mb-1 font-medium">${selections.model}</p>
          <p class="text-sm text-gray-300 font-medium">${selections.sim}</p>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-2 text-white">Installation</h3>
          <p class="text-sm text-gray-300 font-medium">
            ${selections.install} - ${formatter.format(productShipCost)}
          </p>
        </div>
      `;

      if (defaultCountryCode === 'MY') {
        (function(){
          const { deviceOneOff, deviceMonthly, bundled, months } = computePricingForSelections(selections);
          const payIsRTO = /rent-to-own/i.test(selections.payment||'');
          const years = (months%12===0) ? (months/12) : null;

          let totalText;
          if (payIsRTO && deviceMonthly>0) {
            totalText = years ? `${formatter.format(deviceMonthly)}/mth for ${years} years` : `${formatter.format(deviceMonthly)}/mth for ${months} months`;
          } else {
            const total = deviceOneOff + (bundled.total||0) + productShipCost;
            totalText = formatter.format(total);
          }

          col3.innerHTML = `
            <h3 class="text-xl font-bold mb-2 text-white">Payment</h3>
            <p class="text-sm text-gray-300 mb-1 font-medium">${selections.payment}</p>
            <p class="text-sm text-gray-300 font-medium">${selections.tradeIn}</p>
            <h3 class="text-xl font-bold mt-6 mb-2 text-white">Total Due</h3>
            <p id="totalDue" class="text-sm text-gray-300 mb-4 font-normal">${totalText}</p>
            <div class="mt-6 flex justify-center">
              <button
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-3xl"
                onclick="checkoutSubmit()"
              >
                Continue to Payment
              </button>
            </div>
          `;
        })();
      } else {
      col3.innerHTML = `
          <div>
            <h3 class="text-xl font-bold mb-2 text-white">Total Due</h3>
            <p id="totalDue" class="text-sm text-gray-300 mb-4 font-normal"></p>
            <div class="flex justify-center">
              <button
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-20 py-2 rounded-3xl"
                onclick="checkoutSubmit()"
              >
                Continue to Payment
              </button>
            </div>
          </div>
        `;
      }

    } else {
      // → STORE/CART PAGE SUMMARY
      let shippingText;

      countryInput.value = defaultCode;
      countryInput.disabled = false;
      if (defaultCode === "MY") {
        shippingText = "Local Shipping – Free";
      } else {
        shippingText = `International Shipping – ${productShipEntry.name} ${formatter.format(productShipCost)}`;
      }

      col2.innerHTML = `
        <div>
          <h3 class="text-xl font-bold mb-2 text-white">Shipping</h3>
          <p class="text-sm text-gray-300 font-normal">
            ${shippingText}
          </p>
        </div>
      `;

      col3.innerHTML = `
        <div>
          <h3 class="text-xl font-bold mb-2 text-white">Total Due</h3>
          <p id="totalDue" class="text-sm text-gray-300 mb-4 font-normal"></p>
          <div class="flex justify-center">
            <button
              class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-20 py-2 rounded-3xl"
              onclick="checkoutSubmit()"
            >
              Continue to Payment
            </button>
          </div>
        </div>
      `;
    }

    cartItems.forEach(item => {


      const unitPrice = item.prices?.[currency] ?? item.prices?.USD ?? 0;
      const qty       = item.quantity ?? 1;
      const itemTotal = unitPrice * qty;

      const card = document.createElement("div");
      card.className = "flex items-center gap-4 p-3 rounded bg-black";

      const imgWrapper = document.createElement("div");
      imgWrapper.className = "bg-card p-2 rounded-lg";
      const img = document.createElement("img");
      img.src = item.image;
      img.alt = item.name;
      img.className = "w-16 h-16 object-contain";
      imgWrapper.appendChild(img);

      // details
      const details = document.createElement("div");
      details.className = "flex-1";
      const title = document.createElement("p");
      title.className = "text-sm font-semibold";
      title.innerText = item.name;
      const quantityP = document.createElement("p");
      quantityP.className = "text-xs text-gray-400";
      quantityP.innerText = `Qty: ${qty}`;
      const desc = document.createElement("p");
      desc.className = "text-xs text-gray-400";
      desc.innerText = item.selection || "";

      details.appendChild(title);
      details.appendChild(quantityP);
      details.appendChild(desc);

      // price
      const priceEl = document.createElement("p");
      priceEl.className = "text-sm font-medium text-right";
      priceEl.innerText = formatter.format(itemTotal);

      // assemble
      card.appendChild(imgWrapper);
      card.appendChild(details);
      card.appendChild(priceEl);
      cartContainer.appendChild(card);

      // accumulate
      subtotal += itemTotal;
    });

    subtotalDisplay.innerText = formatter.format(subtotal);

    function updateTotalDue() {
      const countryCode = countryInput.value.trim().toUpperCase();
      const totalDueDisplay = document.getElementById("totalDue");

      // find the matching shipping entry
      const entry = shippingConfig.find(e => e.code === countryCode) || {};
      const shipCost = parseFloat(entry.rates?.[currency] || 0);

      // update shipping column
      const countryName = entry.name || countryCode;
      if (countryCode === "MY") {
        shippingText = "Local Shipping – Free";
      } else {
        shippingText = `International Shipping – ${entry.name} ${formatter.format(shipCost)}`;
      }
      if(isFromProduct) {
        col2.innerHTML=`
        <div>
          <h3 class="text-xl font-bold mb-2 text-white">KommuAssist 2</h3>
          <p class="text-sm text-gray-300 mb-1 font-medium">${selections.model}</p>
          <p class="text-sm text-gray-300 font-medium">${selections.sim}</p>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-2 text-white">Installation</h3>
          <p class="text-sm text-gray-300 font-medium">
            ${selections.install} - ${shippingText}
          </p>
        </div>
        `;
        
        if (countryCode === 'MY') {
          (function(){
            const { deviceOneOff, deviceMonthly, bundled, months } = computePricingForSelections(selections);
            const payIsRTO = /rent-to-own/i.test(selections.payment||'');
            const years = (months%12===0) ? (months/12) : null;

            let totalText;
            if (payIsRTO && deviceMonthly>0) {
              totalText = years ? `${formatter.format(deviceMonthly)}/mth for ${years} years` : `${formatter.format(deviceMonthly)}/mth for ${months} months`;
            } else {
              const total = deviceOneOff + (bundled.total||0) + shipCost;
              totalText = formatter.format(total);
            }

            col3.innerHTML = `
              <h3 class="text-xl font-bold mb-2 text-white">Payment</h3>
              <p class="text-sm text-gray-300 mb-1 font-medium">${selections.payment}</p>
              <p class="text-sm text-gray-300 font-medium">${selections.tradeIn}</p>
              <h3 class="text-xl font-bold mt-6 mb-2 text-white">Total Due</h3>
              <p id="totalDue" class="text-sm text-gray-300 mb-4 font-normal">${totalText}</p>
              <div class="mt-6 flex justify-center">
                <button
                  class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-3xl"
                  onclick="checkoutSubmit()"
                >
                  Continue to Payment
                </button>
              </div>
            `;
          })();
        } else {
          (function(){
            const { deviceOneOff, deviceMonthly, bundled, months } = computePricingForSelections(selections);
            const payIsRTO = /rent-to-own/i.test(selections.payment||'');
            const years = (months%12===0) ? (months/12) : null;

            let totalText;
            if (payIsRTO && deviceMonthly>0) {
              totalText = years ? `${formatter.format(deviceMonthly)}/mth for ${years} years` : `${formatter.format(deviceMonthly)}/mth for ${months} months`;
            } else {
              const total = deviceOneOff + (bundled.total||0) + shipCost;
              totalText = formatter.format(total);
            }

            col3.innerHTML = `
              <div>
                <h3 class="text-xl font-bold mb-2 text-white">Total Due</h3>
                <p class="text-sm text-gray-300 font-normal">${selections.payment}</p>
                <p id="totalDue" class="text-sm text-gray-300 mb-10 font-normal">${totalText}</p>
                <div class="flex justify-center">
                  <button
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-20 py-2 rounded-3xl"
                    onclick="checkoutSubmit()"
                  >
                    Continue to Payment
                  </button>
                </div>
              </div>
            `;
          })();
        }
      } else {

        totalDueDisplay.innerText = formatter.format(subtotal + shipCost);
        col2.innerHTML = `
          <div>
            <h3 class="text-xl font-bold mb-2 text-white">Shipping</h3>
            <p class="text-sm text-gray-300 font-normal">
              ${shippingText}
            </p>
          </div>
        `;
      }
    }

    updateTotalDue();
  });


const visaUrl = "https://aws.kommu.ai/curlec/visa?";
const otpUrl = "https://aws.kommu.ai/curlec/otp?";
const stripeUrl = "https://aws.kommu.ai/stripe/checkout?";

function checkoutSubmit() {
  var fromProduct   = false;
  const _urlParams = new URLSearchParams(location.search);
  const _modeParam = _urlParams.get('mode') || _urlParams.get('src');
  if ((_modeParam === 'product') || (sessionStorage.getItem('fromProductPage') === 'true'))  fromProduct = true; 
  const selectionsRaw = sessionStorage.getItem('checkoutSelections');
  const selections    = selectionsRaw ? JSON.parse(selectionsRaw) : {};

  // Plan calculation for submission (recompute with latest selections)
  const plan = (function(){
    const sRaw = sessionStorage.getItem('checkoutSelections');
    const s = sRaw ? JSON.parse(sRaw) : {};
    return (function(sel){
      // reuse computePlan with current selections
      return computePlan();
    })(s);
  })();

  const useVisa = (plan.provider === 'curlec-sub');
  const pricing = computePricingForSelections(selections);

  // common form values
  const name     = document.getElementById("checkoutName").value.trim();
  const ic       = document.getElementById("checkoutIC").value.trim();
  const email    = document.getElementById("checkoutEmail").value.trim();
  const mobile   = document.getElementById("checkoutMobile").value.trim();
  const addr1    = document.getElementById("checkoutAddress").value.trim();
  const addr2    = "";
  const postcode = document.getElementById("checkoutPostcode").value.trim();
  const country  = document.getElementById("checkoutCountry").value.trim().toUpperCase();

  // basic validation
  if (!name || !email || !mobile || !addr1 || !postcode || !country ||
      (document.getElementById("checkoutIC").required && !ic)) {
    alert("Please fill out all required fields.");
    return;
  }

  // calculate subtotal and shipping
  const subText = document.getElementById("checkoutCartSubtotal").innerText.replace(/[^\d.]/g,"");
  const promoCode = document.getElementById("checkoutPromoInput")?.value.trim().toUpperCase() || "";
  let devicePrice = 0;
  if (fromProduct) {
    devicePrice = pricing.deviceOneOff + (pricing.bundled.total||0);
  } else {
    devicePrice = parseFloat(subText) || 0;
  }
  const entry = shippingConfig.find(e => e.code === country) || {};
  const ship  = parseFloat(entry.rates?.[currency] || 0);

  // build params & redirect
  if (useVisa) {
    // rent-to-own → Visa URL
    const duration = pricing.months;
    const subscriptionId = pricing.subscriptionId || ((products.find(p => (p.name||"").toLowerCase()==="kommuassist2")?.subscription?.id) || "");
    const monthlyPayment = (pricing.deviceMonthly || 0).toFixed(2);
    const visaItems = [{
      sim:         selections.sim || "",
      tradeIn:     selections.tradeIn || ""
    }];

    const params = new URLSearchParams();
    params.append("name",             name);
    params.append("email",            email);
    params.append("mobile",           mobile);
    params.append("address1",         addr1);
    params.append("address2",         addr2);
    params.append("postcode",         postcode);
    params.append("nric",             ic);
    params.append("duration",         duration);
    params.append("subscription",     subscriptionId);
    params.append("harness",          selections.model || "");
    params.append("amount",           devicePrice.toFixed(2));
    params.append("monthlyPayment",   monthlyPayment);
    params.append("installation",     selections.install || "");
    params.append("promoCode",        promoCode);
    params.append("deviceProperties", JSON.stringify(visaItems));
    params.append("country",           "Malaysia");
    params.append("currency",          "MYR");

    sessionStorage.setItem("customerName", name);
    window.open(visaUrl + params.toString(), "_blank");
    return;
  }

  // default: One-time payment → OTP or Stripe URL
  const total = devicePrice + ship;
  let lineItems;

  const otpParams = new URLSearchParams({
    name,
    ic,
    email,
    mobile,
    address1: addr1,
    address2: addr2,
    postcode,
    country: entry.name || country,
    currency: (currency || 'MYR'),
    harness: (selections.model || ""),
    installation: (selections.install || ""),
    deviceprice:  devicePrice.toFixed(2),
    shippingrate: ship.toFixed(2),
    amount:       total.toFixed(2),
    promoCode
  });
  if (fromProduct) {
    const deviceProps = {
      sim:     selections.sim || "",
      tradeIn: selections.tradeIn || ""
    };
    otpParams.append("deviceProperties", JSON.stringify(deviceProps));
  } else {
    const cartItems = JSON.parse(localStorage.getItem("cart")) || [];
    lineItems = cartItems.map(i => ({
      name:      i.name,
      quantity:  i.quantity || 1,
      unitPrice: (i.prices[currency]||i.prices.USD).toFixed(2),
      subcategory: i.selection
    }));
  }
  // Always append cart items when present
  if (lineItems && lineItems.length) {
    otpParams.append("items", JSON.stringify(lineItems));
  }

  sessionStorage.setItem("customerName", name);

  let targetUrl = otpUrl;
  if (plan.provider === 'stripe') targetUrl = stripeUrl;
  if (plan.provider === 'curlec-otp') targetUrl = otpUrl;

  // Enforce country/currency for each case
  if (plan.mode === 'product') {
    if (plan.provider === 'curlec-otp') {
      otpParams.set('country', 'Malaysia');
      otpParams.set('currency', 'MYR');
    }
    if (plan.provider === 'stripe') {
      // country(name) already from dropdown; currency already set above
      // also force one-off & locks already applied in selections
    }
  } else {
    // cart accessories-only
    if (plan.provider === 'curlec-otp') {
      otpParams.set('country', 'Malaysia');
      otpParams.set('currency', 'MYR');
    }
  }

  window.open(targetUrl + otpParams.toString(), "_blank");
}

</script>
