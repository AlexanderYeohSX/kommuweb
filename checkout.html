---
layout: default
title: Checkout
---
<!-- Checkout Page Layout -->
<div class="max-w-6xl mx-auto px-4 py-12">
  <!-- Checkout Title -->
  <div class="text-left mb-10">
    <h1 class="text-4xl font-bold mb-2 text-white">Checkout</h1>
  </div>

  <!-- Form and Cart Summary Layout -->
  <div id="checkoutGrid" class="grid md:grid-cols-2 gap-8">
    <!-- Left Form Fields -->
    <div class="text-white space-y-6">
      <div>
        <label for="checkoutName" class="block text-sm font-semibold mb-1">First Name</label>
        <input id="checkoutName" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div id="checkoutICGroup" class="hidden">
        <label for="checkoutIC" class="block text-sm font-semibold mb-1">
          Malaysian IC No. (without –)
        </label>
        <input id="checkoutIC" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" pattern="\d{12}" required
        >
      </div>
      <div>
        <label for="checkoutEmail" class="block text-sm font-semibold mb-1">Email</label>
        <input id="checkoutEmail" type="email" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div>
        <label for="checkoutMobile" class="block text-sm font-semibold mb-1">Contact number</label>
        <input id="checkoutMobile" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div>
        <label for="checkoutAddress" class="block text-sm font-semibold mb-1">Street Address</label>
        <input id="checkoutAddress" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div>
        <label for="checkoutPostcode" class="block text-sm font-semibold mb-1">Postcode</label>
        <input id="checkoutPostcode" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div>
        <label for="checkoutCountry" class="block text-sm font-semibold mb-1">Country</label>
        <input id="checkoutCountry" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded" required>
      </div>
      <div id="checkoutPromoGroup" class="mt-4">
        <label for="checkoutPromoInput" class="block text-sm font-semibold mb-1">Promo code</label>
        <input id="checkoutPromoInput" type="text" class="w-full bg-black border border-gray-700 px-4 py-3 rounded">
        <p id="checkoutPromoValidity" class="text-yellow-400 mt-1" hidden></p>
      </div>
    </div>

    <!-- Right Cart Summary -->
    <div id="checkoutCartSection" class="text-white">
      <h2 class="text-lg font-semibold mb-4 text-white">Your Cart</h2>
      <div id="checkoutCartItems" class="space-y-4 mb-6"></div>
      <div class="text-sm text-right">
        <p class="mb-1">Subtotal <span id="checkoutCartSubtotal" class="font-semibold ml-2">RM0</span></p>
        <p class="text-xs text-gray-400">Customs duties and import taxes for international orders are not included and may be charged separately by your local authorities.</p>
      </div>
    </div>
  </div>
</div>
<section class="w-full bg-card py-6">
  <div class="max-w-6xl mx-auto px-6 text-white grid md:grid-cols-3 gap-6">
    <!-- Col 1: image & headline -->
    <div>
      <h2 id="summaryHeading" class="text-2xl font-bold mb-2 text-white">Welcome to Kommunity</h2>
      <p class="font-medium mb-6">Cruise with intelligence.</p>
      <img
        src="{{ '/img/products/device/1.png' | relative_url }}"
        alt="Summary image"
        class="w-full rounded"
      >
    </div>

    <!-- Col 2: placeholder for either product summary or shipping -->
    <div id="summaryCol2" class="space-y-6">
      <!-- will be filled by JS -->
    </div>

    <!-- Col 3: placeholder for either payment summary+CTA or total due-->
    <div id="summaryCol3">
      <!-- will be filled by JS -->
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const cartItems = JSON.parse(localStorage.getItem("cart")) || [];
  const selectionsRaw = localStorage.getItem("checkoutSelections");

  const cartSection = document.getElementById("checkoutCartSection");
  const formGrid = document.getElementById("checkoutGrid");
  const cartContainer = document.getElementById("checkoutCartItems");
  const subtotalDisplay = document.getElementById("checkoutCartSubtotal");
  const col2 = document.getElementById("summaryCol2");
  const col3 = document.getElementById("summaryCol3");
  const heading    = document.getElementById("summaryHeading");


  const isFromProduct = localStorage.getItem("fromProductPage") === "true";

  let subtotal = 0;
  let selections = {};
  if (isFromProduct && selectionsRaw) {
    selections = JSON.parse(selectionsRaw);
  }

  // only show IC when user is RTO
  const icGroup = document.getElementById("checkoutICGroup");
  const icInput = document.getElementById("checkoutIC");
  if (
    isFromProduct &&
    selections.payment &&
    selections.payment.toLowerCase().includes("rent-to-own")
  ) {
    icGroup.classList.remove("hidden");
    icInput.required = true;
  } else {
    icGroup.classList.add("hidden");
    icInput.required = false;
  }

  const promoGroup = document.getElementById("checkoutPromoGroup");
  if (isFromProduct) {
    promoGroup.classList.remove("hidden");
  } else {
    promoGroup.classList.add("hidden");
  }


  if (isFromProduct && Object.keys(selections).length) {
    heading.innerText    = "Your new KommuAssist";
    document.getElementById("checkoutCartSection").style.display = "none";
    document.getElementById("checkoutGrid").classList.remove("md:grid-cols-2");

    col2.innerHTML = `
      <div>
        <h3 class="text-xl font-bold mb-2 text-white">KommuAssist 2</h3>
        <p class="text-sm text-gray-300 mb-1 font-medium">${selections.model}</p>
        <p class="text-sm text-gray-300 font-medium">${selections.sim}</p>
      </div>
      <div>
        <h3 class="text-xl font-bold mb-2 text-white">Installation</h3>
        <p class="text-sm text-gray-300 font-medium">${selections.install}</p>
      </div>
    `;

    col3.innerHTML = `
      <h3 class="text-xl font-bold mb-2 text-white">Payment</h3>
      <p class="text-sm text-gray-300 mb-1 font-medium">${selections.payment}</p>
      <p class="text-sm text-gray-300 font-medium">${selections.tradeIn}</p>
      <div class="mt-6 flex justify-center">
        <button
          class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-3xl"
          onclick="goToPayment()"
        >
          Continue to Payment
        </button>
      </div>
    `;

    // clear the flags so a refresh doesn't re-show it
    localStorage.removeItem("fromProductPage");
    localStorage.removeItem("checkoutSelections");

  } else {
    // → STORE/CART PAGE SUMMARY

    col2.innerHTML = `
      <div>
        <h3 class="text-xl font-bold mb-2 text-white">Shipping</h3>
        <p class="text-sm text-gray-300 font-normal">
          Local Shipping - RM10<br>
          International Shipping - Thailand RM395
        </p>
      </div>
    `;

    col3.innerHTML = `
      <div>
        <h3 class="text-xl font-bold mb-2 text-white">Total Due</h3>
        <p id="totalDue" class="text-sm text-gray-300 mb-4 font-normal"></p>
        <div class="flex justify-center">
          <button
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-20 py-2 rounded-3xl"
            onclick="goToPayment()"
          >
            Continue to Payment
          </button>
        </div>
      </div>
    `;
  }

  cartItems.forEach(item => {
    const locale = localStorage.getItem("preferredLocale") || navigator.language || "en-US";
    const currency = getCurrencyCode(locale);
    const formatter = getFormatter(locale);

    const unitPrice = item.prices?.[currency] ?? item.prices?.USD ?? 0;
    const qty       = item.quantity ?? 1;
    const itemTotal = unitPrice * qty;

    const card = document.createElement("div");
    card.className = "flex items-center gap-4 p-3 rounded bg-black";

    const imgWrapper = document.createElement("div");
    imgWrapper.className = "bg-card p-2 rounded-lg";
    const img = document.createElement("img");
    img.src = item.image;
    img.alt = item.name;
    img.className = "w-16 h-16 object-contain";
    imgWrapper.appendChild(img);

    // details
    const details = document.createElement("div");
    details.className = "flex-1";
    const title = document.createElement("p");
    title.className = "text-sm font-semibold";
    title.innerText = item.name;
    const quantityP = document.createElement("p");
    quantityP.className = "text-xs text-gray-400";
    quantityP.innerText = `Qty: ${qty}`;
    const desc = document.createElement("p");
    desc.className = "text-xs text-gray-400";
    desc.innerText = item.description || "";

    details.appendChild(title);
    details.appendChild(quantityP);
    details.appendChild(desc);

    // price
    const priceEl = document.createElement("p");
    priceEl.className = "text-sm font-medium text-right";
    priceEl.innerText = formatter.format(itemTotal);

    // assemble
    card.appendChild(imgWrapper);
    card.appendChild(details);
    card.appendChild(priceEl);
    cartContainer.appendChild(card);

    // accumulate
    subtotal += itemTotal;
  });

  const locale = localStorage.getItem("preferredLocale") || navigator.language || "en-US";
  const formatter = getFormatter(locale);
  const totalDueDisplay = document.getElementById("totalDue");

  subtotalDisplay.innerText = formatter.format(subtotal);
  totalDueDisplay.innerText = formatter.format(subtotal);
});


const visaUrl = "https://aws.kommu.ai/curlec/visa?";
const otpUrl = "https://aws.kommu.ai/curlec/otp?";
const shippingRate   = { MY:0.00, TH:209.99, SG:245.63, AU:422.73 };
const countries      = { MY:"Malaysia", TH:"Thailand", SG:"Singapore", AU:"Australia" };

function checkoutSubmit() {
  const requiredIds = [
    "checkoutName",
    "checkoutIC",
    "checkoutEmail",
    "checkoutMobile",
    "checkoutAddress",
    "checkoutPostcode",
    "checkoutCountry"
  ];
  for (let id of requiredIds) {
    const el = document.getElementById(id);
    if (!el.value.trim()) {
      alert("Please fill out all required fields.");
      el.focus();
      return;
    }
  }

  const name     = document.getElementById("checkoutName").value.trim();
  const ic       = document.getElementById("checkoutIC").value.trim();
  const email    = document.getElementById("checkoutEmail").value.trim();
  const mobile   = document.getElementById("checkoutMobile").value.trim();
  const addr1    = document.getElementById("checkoutAddress").value.trim();
  const postcode = document.getElementById("checkoutPostcode").value.trim();
  const country  = document.getElementById("checkoutCountry").value.trim().toUpperCase();
  const ship     = parseFloat(shippingRate[country]||0);

  // 3) pricing & promo (unchanged)…
  //    …[your existing promo & subtotal logic here]…

  // 4) build & redirect
  const params = new URLSearchParams({
    name,
    ic,                  // added
    email,
    mobile,
    address1: addr1,
    address2: addr2,
    postcode,
    country: countries[country]||country,
    promoCode,           // from your promo logic
    deviceprice: devicePrice.toFixed(2),
    shippingrate: ship.toFixed(2),
    amount: total.toFixed(2)
  });

  window.open(checkoutUrl + params.toString(), "_blank");
}



</script>
